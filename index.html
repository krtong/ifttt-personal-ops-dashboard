<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Personal Ops Report</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b1020;
        --panel: rgba(13, 19, 35, 0.95);
        --panel-strong: rgba(12, 18, 34, 0.95);
        --card: rgba(9, 14, 28, 0.7);
        --text: #f8fafc;
        --muted: #9aa6bd;
        --accent: #38bdf8;
        --accent-strong: #0ea5e9;
        --border: rgba(59, 78, 119, 0.45);
        --danger: #f97316;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Space Grotesk", system-ui, sans-serif;
        background: radial-gradient(circle at top, #111827 0%, #0b1020 52%, #070b16 100%);
        color: var(--text);
        height: 100vh;
        overflow: hidden;
      }
      .shell {
        height: 100vh;
        display: grid;
        grid-template-rows: auto 1fr;
      }
      header {
        padding: 24px clamp(20px, 6vw, 60px) 16px;
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 24px;
      }
      .title {
        font-size: clamp(26px, 4vw, 40px);
        font-weight: 700;
        letter-spacing: -0.02em;
      }
      .subtitle {
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
      }
      .header-meta {
        text-align: right;
        font-size: 12px;
        color: var(--muted);
      }
      .header-meta strong {
        color: var(--text);
        font-weight: 600;
      }
      .auth {
        max-width: 420px;
        margin: 40px auto;
        display: grid;
        gap: 12px;
        padding: 24px;
        background: var(--panel-strong);
        border-radius: 20px;
        border: 1px solid var(--border);
      }
      .auth input {
        background: rgba(12, 18, 34, 0.9);
        border: 1px solid rgba(59, 78, 119, 0.6);
        border-radius: 10px;
        padding: 10px 12px;
        color: var(--text);
      }
      .btn {
        padding: 10px 16px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent-strong);
        color: #041018;
      }
      .btn.secondary {
        background: rgba(30, 41, 59, 0.8);
        color: var(--text);
        border: 1px solid rgba(59, 78, 119, 0.6);
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      main.report {
        padding: 0 clamp(16px, 5vw, 48px) 20px;
        display: grid;
        gap: 16px;
        height: 100%;
      }
      .report-grid {
        display: grid;
        gap: 16px;
        height: 100%;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        grid-template-rows: repeat(4, minmax(0, 1fr));
        grid-template-areas:
          "summary summary nutrition nutrition"
          "training training nutrition nutrition"
          "sleep sleep strength strength"
          "body body strength strength";
      }
      .section {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 16px;
        display: grid;
        grid-template-rows: auto auto 1fr;
        gap: 12px;
        overflow: hidden;
      }
      .section.summary { grid-area: summary; }
      .section.training { grid-area: training; }
      .section.nutrition { grid-area: nutrition; }
      .section.sleep { grid-area: sleep; }
      .section.strength { grid-area: strength; }
      .section.body { grid-area: body; }

      .section-head {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 10px;
      }
      .section-title {
        font-size: 16px;
        font-weight: 600;
      }
      .section-meta {
        font-size: 11px;
        color: var(--muted);
      }
      .section-state {
        font-size: 13px;
        line-height: 1.4;
        color: var(--text);
      }
      .hero-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 8px;
      }
      .hero-action {
        background: var(--card);
        border: 1px solid rgba(59, 78, 119, 0.4);
        border-radius: 12px;
        padding: 10px 12px;
        font-size: 12px;
        line-height: 1.4;
      }
      .hero-action strong {
        display: block;
        font-size: 12px;
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--muted);
      }
      .confidence {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        font-size: 11px;
      }
      .confidence .chip {
        border-radius: 999px;
        padding: 4px 10px;
        border: 1px solid rgba(56, 189, 248, 0.35);
        color: var(--accent);
        background: rgba(14, 165, 233, 0.12);
      }
      .confidence .chip.warn {
        border-color: rgba(249, 115, 22, 0.55);
        color: #fcd34d;
        background: rgba(249, 115, 22, 0.12);
      }
      .evidence {
        display: grid;
        gap: 10px;
        overflow: hidden;
      }
      .evidence-grid {
        display: grid;
        gap: 4px;
        grid-template-columns: 1.6fr 1fr 1fr 1fr 1fr;
        font-size: 11px;
        color: var(--muted);
      }
      .evidence-grid .head {
        color: var(--text);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .evidence-row {
        display: contents;
      }
      .evidence-row span {
        padding: 4px 0;
        border-bottom: 1px solid rgba(30, 41, 59, 0.6);
      }
      .evidence-row strong {
        color: var(--text);
      }
      .subpanel {
        border: 1px solid rgba(59, 78, 119, 0.35);
        border-radius: 14px;
        padding: 8px 10px;
        display: grid;
        gap: 6px;
        background: rgba(9, 14, 28, 0.7);
      }
      .subpanel-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--muted);
      }
      .report-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0 0;
        font-size: 11px;
        color: var(--muted);
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <header>
        <div>
          <div class="title">Personal Ops - Single Page Report</div>
          <div class="subtitle">Evidence-first report for training, fuel, and recovery.</div>
        </div>
        <div class="header-meta">
          <div id="report-updated">Updated —</div>
          <div id="race-countdown">Race —</div>
        </div>
      </header>

      <div id="auth" class="auth">
        <div class="section-title">Sign in</div>
        <input id="email" type="email" placeholder="Email" />
        <input id="password" type="password" placeholder="Password" />
        <button id="login" class="btn">Sign in</button>
        <div id="auth-status" class="muted"></div>
      </div>

      <main id="content" class="report hidden">
        <div class="report-grid">
          <section class="section summary" data-importance="10">
            <div class="section-head">
              <div class="section-title">Operational summary</div>
              <div class="section-meta" id="summary-updated">—</div>
            </div>
            <div class="section-state" id="summary-state">—</div>
            <div class="hero-actions" id="summary-actions"></div>
            <div class="confidence" id="summary-confidence"></div>
            <div class="evidence">
              <div class="evidence-grid" id="summary-evidence"></div>
            </div>
          </section>

          <section class="section nutrition" data-importance="10">
            <div class="section-head">
              <div class="section-title">Nutrition + fuel</div>
              <div class="section-meta" id="nutrition-updated">—</div>
            </div>
            <div class="section-state" id="nutrition-state">—</div>
            <div class="hero-actions" id="nutrition-actions"></div>
            <div class="confidence" id="nutrition-confidence"></div>
            <div class="evidence">
              <div class="subpanel">
                <div class="subpanel-title">Coverage</div>
                <div class="evidence-grid" id="nutrition-coverage"></div>
              </div>
              <div class="subpanel">
                <div class="subpanel-title">Energy availability</div>
                <div class="evidence-grid" id="nutrition-ea"></div>
              </div>
              <div class="subpanel">
                <div class="subpanel-title">Macros</div>
                <div class="evidence-grid" id="nutrition-macros"></div>
              </div>
              <div class="subpanel">
                <div class="subpanel-title">Periodization</div>
                <div class="evidence-grid" id="nutrition-period"></div>
              </div>
              <div class="subpanel">
                <div class="subpanel-title">Micronutrients</div>
                <div class="evidence-grid" id="nutrition-micros"></div>
              </div>
            </div>
          </section>

          <section class="section training" data-importance="9">
            <div class="section-head">
              <div class="section-title">Training plan + load</div>
              <div class="section-meta" id="training-updated">—</div>
            </div>
            <div class="section-state" id="training-state">—</div>
            <div class="hero-actions" id="training-actions"></div>
            <div class="confidence" id="training-confidence"></div>
            <div class="evidence">
              <div class="evidence-grid" id="training-evidence"></div>
            </div>
          </section>

          <section class="section sleep" data-importance="9">
            <div class="section-head">
              <div class="section-title">Sleep + recovery</div>
              <div class="section-meta" id="sleep-updated">—</div>
            </div>
            <div class="section-state" id="sleep-state">—</div>
            <div class="hero-actions" id="sleep-actions"></div>
            <div class="confidence" id="sleep-confidence"></div>
            <div class="evidence">
              <div class="evidence-grid" id="sleep-evidence"></div>
            </div>
          </section>

          <section class="section strength" data-importance="8">
            <div class="section-head">
              <div class="section-title">Strength + PT</div>
              <div class="section-meta" id="strength-updated">—</div>
            </div>
            <div class="section-state" id="strength-state">—</div>
            <div class="hero-actions" id="strength-actions"></div>
            <div class="confidence" id="strength-confidence"></div>
            <div class="evidence">
              <div class="evidence-grid" id="strength-evidence"></div>
            </div>
          </section>

          <section class="section body" data-importance="8">
            <div class="section-head">
              <div class="section-title">Body comp + trend</div>
              <div class="section-meta" id="body-updated">—</div>
            </div>
            <div class="section-state" id="body-state">—</div>
            <div class="hero-actions" id="body-actions"></div>
            <div class="confidence" id="body-confidence"></div>
            <div class="evidence">
              <div class="evidence-grid" id="body-evidence"></div>
            </div>
          </section>
        </div>
        <div class="report-footer">
          <button id="logout" class="btn secondary">Sign out</button>
          <div id="report-window">—</div>
        </div>
      </main>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const SUPABASE_URL = "https://tbrnarytcojngpbzzwcn.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_E8-dvNNh5V3VQLAcK-xqiQ_dLEu1Bsh";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const authEl = document.getElementById("auth");
      const authStatusEl = document.getElementById("auth-status");
      const contentEl = document.getElementById("content");
      const emailEl = document.getElementById("email");
      const passwordEl = document.getElementById("password");
      const reportUpdatedEl = document.getElementById("report-updated");
      const reportWindowEl = document.getElementById("report-window");
      const raceCountdownEl = document.getElementById("race-countdown");

      const summaryStateEl = document.getElementById("summary-state");
      const summaryActionsEl = document.getElementById("summary-actions");
      const summaryConfidenceEl = document.getElementById("summary-confidence");
      const summaryEvidenceEl = document.getElementById("summary-evidence");
      const summaryUpdatedEl = document.getElementById("summary-updated");

      const nutritionStateEl = document.getElementById("nutrition-state");
      const nutritionActionsEl = document.getElementById("nutrition-actions");
      const nutritionConfidenceEl = document.getElementById("nutrition-confidence");
      const nutritionCoverageEl = document.getElementById("nutrition-coverage");
      const nutritionEaEl = document.getElementById("nutrition-ea");
      const nutritionMacrosEl = document.getElementById("nutrition-macros");
      const nutritionPeriodEl = document.getElementById("nutrition-period");
      const nutritionMicrosEl = document.getElementById("nutrition-micros");
      const nutritionUpdatedEl = document.getElementById("nutrition-updated");

      const trainingStateEl = document.getElementById("training-state");
      const trainingActionsEl = document.getElementById("training-actions");
      const trainingConfidenceEl = document.getElementById("training-confidence");
      const trainingEvidenceEl = document.getElementById("training-evidence");
      const trainingUpdatedEl = document.getElementById("training-updated");

      const sleepStateEl = document.getElementById("sleep-state");
      const sleepActionsEl = document.getElementById("sleep-actions");
      const sleepConfidenceEl = document.getElementById("sleep-confidence");
      const sleepEvidenceEl = document.getElementById("sleep-evidence");
      const sleepUpdatedEl = document.getElementById("sleep-updated");

      const strengthStateEl = document.getElementById("strength-state");
      const strengthActionsEl = document.getElementById("strength-actions");
      const strengthConfidenceEl = document.getElementById("strength-confidence");
      const strengthEvidenceEl = document.getElementById("strength-evidence");
      const strengthUpdatedEl = document.getElementById("strength-updated");

      const bodyStateEl = document.getElementById("body-state");
      const bodyActionsEl = document.getElementById("body-actions");
      const bodyConfidenceEl = document.getElementById("body-confidence");
      const bodyEvidenceEl = document.getElementById("body-evidence");
      const bodyUpdatedEl = document.getElementById("body-updated");

      const RACE_DATE = new Date("2026-06-06T00:00:00-07:00");

      function formatNumber(value, decimals = 0) {
        if (value === null || value === undefined || Number.isNaN(value)) return "—";
        return Number(value).toFixed(decimals);
      }

      function formatMinutes(seconds) {
        if (seconds === null || seconds === undefined) return "—";
        return `${Math.round(Number(seconds) / 60)} min`;
      }

      function formatHours(seconds) {
        if (seconds === null || seconds === undefined) return "—";
        return `${(Number(seconds) / 3600).toFixed(1)} h`;
      }

      function formatDistance(meters) {
        if (meters === null || meters === undefined) return "—";
        return `${(Number(meters) / 1609.34).toFixed(1)} mi`;
      }

      function formatDate(value) {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "—";
        return date.toLocaleDateString();
      }

      function formatTimestamp(value) {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "—";
        return date.toLocaleString();
      }

      function clearElement(el) {
        if (el) el.innerHTML = "";
      }

      function renderActions(el, actions) {
        clearElement(el);
        if (!actions || !actions.length) {
          const item = document.createElement("div");
          item.className = "hero-action";
          item.innerHTML = `<strong>Actions</strong>No changes triggered for this domain.`;
          el.appendChild(item);
          return;
        }
        actions.slice(0, 5).forEach((action) => {
          const item = document.createElement("div");
          item.className = "hero-action";
          item.innerHTML = `<strong>${action.title}</strong>${action.body}`;
          el.appendChild(item);
        });
      }

      function renderConfidence(el, items) {
        clearElement(el);
        if (!items || !items.length) return;
        items.forEach((item) => {
          const chip = document.createElement("span");
          chip.className = `chip${item.warn ? " warn" : ""}`;
          chip.textContent = item.label;
          el.appendChild(chip);
        });
      }

      function renderEvidence(el, rows) {
        clearElement(el);
        const header = document.createElement("div");
        header.className = "evidence-grid";
        header.innerHTML = `
          <div class="head">Metric</div>
          <div class="head">Current</div>
          <div class="head">Target</div>
          <div class="head">Window</div>
          <div class="head">Trend</div>
        `;
        el.appendChild(header);
        const grid = document.createElement("div");
        grid.className = "evidence-grid";
        rows.forEach((row) => {
          const wrapper = document.createElement("div");
          wrapper.className = "evidence-row";
          wrapper.setAttribute("data-metric-importance", row.importance || "5");
          wrapper.innerHTML = `
            <span>${row.label}</span>
            <span><strong>${row.current}</strong></span>
            <span>${row.target}</span>
            <span>${row.window}</span>
            <span>${row.trend}</span>
          `;
          grid.appendChild(wrapper);
        });
        el.appendChild(grid);
      }

      function trendDelta(current, previous, decimals = 1) {
        if (current === null || current === undefined || previous === null || previous === undefined) return "—";
        const delta = Number(current) - Number(previous);
        const sign = delta >= 0 ? "+" : "";
        return `${sign}${delta.toFixed(decimals)}`;
      }

      async function fetchLatest(table, orderKey) {
        const { data } = await supabase.from(table).select("*").order(orderKey, { ascending: false }).limit(1);
        return data && data[0] ? data[0] : null;
      }

      async function fetchLatestTwo(table, orderKey) {
        const { data } = await supabase.from(table).select("*").order(orderKey, { ascending: false }).limit(2);
        if (!data || data.length === 0) return [null, null];
        return [data[0], data[1] || null];
      }

      function daysBetween(dateA, dateB) {
        const ms = dateB.getTime() - dateA.getTime();
        return Math.ceil(ms / (1000 * 60 * 60 * 24));
      }

      function buildAction(action) {
        if (!action) return null;
        if (action.message) {
          return { title: "Action", body: action.message };
        }
        if (action.target && action.delta_g_per_day) {
          return { title: "Adjust", body: `${action.target}: add ${action.delta_g_per_day} g/day for ${action.days}` };
        }
        if (action.target && action.delta_g_per_key_day) {
          return { title: "Adjust", body: `${action.target}: add ${action.delta_g_per_key_day} g on ${action.days}` };
        }
        if (action.delta_kcal_per_day) {
          return { title: "Adjust", body: `Add ${action.delta_kcal_per_day} kcal/day for ${action.days}` };
        }
        if (action.target) {
          return { title: "Action", body: `${action.target} - ${action.days || "next"}` };
        }
        return null;
      }

      async function loadReport() {
        const [trainingWeek, trainingPrev] = await fetchLatestTwo("health_agg_weekly.training", "week_start");
        const [enduranceWeek, endurancePrev] = await fetchLatestTwo("health_agg_weekly.endurance", "week_start");
        const [strengthWeek, strengthPrev] = await fetchLatestTwo("health_agg_weekly.strength", "week_start");
        const [coverageWeek] = await fetchLatestTwo("health_agg_weekly.coverage", "week_start");
        const [macroWeek] = await fetchLatestTwo("health_agg_weekly.macro_adequacy", "week_start");
        const [eaWeek] = await fetchLatestTwo("health_agg_weekly.energy_availability", "week_start");
        const [conservationWeek] = await fetchLatestTwo("health_agg_weekly.conservation", "week_start");
        const { data: microsRows } = await supabase
          .from("health_agg_weekly.micronutrients")
          .select("nutrient_name,hit_rate_28d,sustained_low")
          .order("week_start", { ascending: false })
          .limit(12);

        const dailySleep = await fetchLatest("health_agg_daily.sleep", "day");
        const dailyBody = await fetchLatest("health_agg_daily.body", "day");

        const { data: planRows } = await supabase.from("coach_plan_daily").select("date,summary_text,plan_json").order("date", { ascending: false }).limit(1);
        const plan = planRows && planRows[0] ? planRows[0] : null;

        const { data: recRows } = await supabase.from("health_agg_weekly.recommendations").select("week_start,domain,action").order("week_start", { ascending: false }).limit(40);
        const latestWeek = trainingWeek?.week_start || coverageWeek?.week_start || macroWeek?.week_start || eaWeek?.week_start;
        const recommendations = (recRows || []).filter((row) => row.week_start === latestWeek);

        const updatedStamp = trainingWeek?.updated_at || coverageWeek?.updated_at || macroWeek?.updated_at || eaWeek?.updated_at;
        reportUpdatedEl.textContent = `Updated ${formatTimestamp(updatedStamp)}`;
        if (latestWeek) {
          reportWindowEl.textContent = `Week starting ${latestWeek}`;
          summaryUpdatedEl.textContent = `Week of ${latestWeek}`;
          nutritionUpdatedEl.textContent = `Week of ${latestWeek}`;
          trainingUpdatedEl.textContent = `Week of ${latestWeek}`;
          strengthUpdatedEl.textContent = `Week of ${latestWeek}`;
          bodyUpdatedEl.textContent = dailyBody?.measured_at ? `Measured ${formatDate(dailyBody.measured_at)}` : `Week of ${latestWeek}`;
          sleepUpdatedEl.textContent = dailySleep?.sleep_end ? `Last sleep ${formatDate(dailySleep.sleep_end)}` : `Week of ${latestWeek}`;
        }

        const daysToRace = daysBetween(new Date(), RACE_DATE);
        raceCountdownEl.textContent = `Escape from Alcatraz 2026 in ${daysToRace} days`;

        const summaryConstraints = [];
        if (coverageWeek?.nutrition_coverage !== null && coverageWeek?.nutrition_coverage < 0.6) {
          summaryConstraints.push(`Nutrition coverage ${formatNumber(coverageWeek.nutrition_coverage * 100, 0)}% (${coverageWeek.nutrition_days_logged || 0}/7 days logged)`);
        }
        if (coverageWeek?.weight_stale_days !== null && coverageWeek?.weight_stale_days > 7) {
          summaryConstraints.push(`Weight stale ${formatNumber(coverageWeek.weight_stale_days, 1)}d`);
        }
        if (eaWeek?.ea_kcal_per_kg !== null && eaWeek?.ea_kcal_per_kg < 30) {
          summaryConstraints.push(`Energy availability ${formatNumber(eaWeek.ea_kcal_per_kg, 1)} kcal/kg (below 30)`);
        }
        const constraintText = summaryConstraints[0] || "No dominant constraint detected; review domain panels for detail.";
        summaryStateEl.textContent = constraintText;

        const summaryActions = [];
        if (plan?.plan_json?.recommendation) {
          const rec = plan.plan_json.recommendation;
          summaryActions.push({
            title: "Today plan",
            body: `${rec.type || "session"} · ${rec.duration_min || "—"} min · ${rec.intensity || "—"}`,
          });
        }
        recommendations.forEach((rec) => {
          const action = buildAction(rec.action);
          if (action) summaryActions.push(action);
        });
        renderActions(summaryActionsEl, summaryActions);

        const summaryConfidence = [];
        if (coverageWeek?.confidence != null) {
          summaryConfidence.push({ label: `Confidence ${formatNumber(coverageWeek.confidence * 100, 0)}%`, warn: coverageWeek.confidence < 0.6 });
        }
        if (coverageWeek?.nutrition_days_logged != null) {
          summaryConfidence.push({ label: `Nutrition logs ${coverageWeek.nutrition_days_logged}/7`, warn: coverageWeek.nutrition_days_logged < 5 });
        }
        if (coverageWeek?.weight_stale_days != null) {
          summaryConfidence.push({ label: `Weight stale ${formatNumber(coverageWeek.weight_stale_days, 1)}d`, warn: coverageWeek.weight_stale_days > 7 });
        }
        renderConfidence(summaryConfidenceEl, summaryConfidence);

        renderEvidence(summaryEvidenceEl, [
          { label: "Workouts (7d)", current: trainingWeek?.workout_count ?? "—", target: coverageWeek?.planned_sessions ?? "—", window: "7d", trend: trainingPrev ? trendDelta(trainingWeek?.workout_count, trainingPrev?.workout_count, 0) : "—", importance: 9 },
          { label: "Training minutes", current: formatMinutes(trainingWeek?.total_duration_s), target: "—", window: "7d", trend: trainingPrev ? trendDelta(trainingWeek?.total_duration_s, trainingPrev?.total_duration_s, 0) : "—", importance: 8 },
          { label: "Sleep last", current: formatHours(dailySleep?.duration_s), target: "7.0 h", window: "last sleep", trend: "—", importance: 8 },
          { label: "Energy availability", current: eaWeek?.ea_kcal_per_kg ? formatNumber(eaWeek.ea_kcal_per_kg, 1) : "—", target: ">=45", window: "7d avg", trend: "—", importance: 8 },
        ]);

        const nutritionState = `Intake avg ${formatNumber(macroWeek?.avg_protein_g_day, 0)} g protein/day (${formatNumber(macroWeek?.avg_protein_g_per_kg_day, 2)} g/kg), EA ${formatNumber(eaWeek?.ea_kcal_per_kg, 1)} kcal/kg.`;
        nutritionStateEl.textContent = nutritionState;

        const nutritionActions = recommendations.filter((rec) => rec.domain === "nutrition" || rec.domain === "recovery").map((rec) => buildAction(rec.action)).filter(Boolean);
        renderActions(nutritionActionsEl, nutritionActions);

        const nutritionConf = [];
        if (coverageWeek?.nutrition_confidence != null) {
          nutritionConf.push({ label: `Confidence ${formatNumber(coverageWeek.nutrition_confidence * 100, 0)}%`, warn: coverageWeek.nutrition_confidence < 0.6 });
        }
        if (coverageWeek?.nutrition_days_logged != null) {
          nutritionConf.push({ label: `Days logged ${coverageWeek.nutrition_days_logged}/7`, warn: coverageWeek.nutrition_days_logged < 5 });
        }
        renderConfidence(nutritionConfidenceEl, nutritionConf);

        renderEvidence(nutritionCoverageEl, [
          { label: "Days logged", current: coverageWeek?.nutrition_days_logged ?? "—", target: "6/7", window: "7d", trend: "—", importance: 9 },
          { label: "Meal coverage", current: coverageWeek?.meal_coverage != null ? `${formatNumber(coverageWeek.meal_coverage * 100, 0)}%` : "—", target: ">=70%", window: "7d", trend: "—", importance: 7 },
          { label: "Meals logged", current: coverageWeek?.meals_logged ?? "—", target: coverageWeek?.expected_meals ?? "—", window: "7d", trend: "—", importance: 6 },
        ]);

        renderEvidence(nutritionEaEl, [
          { label: "EA kcal/kg", current: eaWeek?.ea_kcal_per_kg != null ? formatNumber(eaWeek.ea_kcal_per_kg, 1) : "—", target: ">=45", window: "7d", trend: "—", importance: 9 },
          { label: "Avg intake", current: eaWeek?.avg_intake_kcal_day != null ? `${formatNumber(eaWeek.avg_intake_kcal_day, 0)} kcal` : "—", target: "—", window: "7d", trend: "—", importance: 6 },
          { label: "Avg exercise", current: eaWeek?.avg_exercise_kcal_day != null ? `${formatNumber(eaWeek.avg_exercise_kcal_day, 0)} kcal` : "—", target: "—", window: "7d", trend: "—", importance: 6 },
        ]);

        renderEvidence(nutritionMacrosEl, [
          { label: "Protein g/kg", current: macroWeek?.avg_protein_g_per_kg_day != null ? formatNumber(macroWeek.avg_protein_g_per_kg_day, 2) : "—", target: ">=1.6", window: "7d avg", trend: "—", importance: 9 },
          { label: "Protein meal hit", current: macroWeek?.protein_meal_hit_rate != null ? `${formatNumber(macroWeek.protein_meal_hit_rate * 100, 0)}%` : "—", target: ">=60%", window: "7d", trend: "—", importance: 7 },
          { label: "Fat floor ok", current: macroWeek?.fat_floor_ok_days != null ? `${macroWeek.fat_floor_ok_days}/7` : "—", target: ">=5/7", window: "7d", trend: "—", importance: 6 },
        ]);

        renderEvidence(nutritionPeriodEl, [
          { label: "Key days", current: macroWeek?.key_days ?? "—", target: "—", window: "7d", trend: "—", importance: 6 },
          { label: "Carb under days", current: macroWeek?.carb_under_days ?? "—", target: "0", window: "7d", trend: "—", importance: 6 },
          { label: "Avg carbs g", current: macroWeek?.avg_carbs_g_day != null ? formatNumber(macroWeek.avg_carbs_g_day, 0) : "—", target: "—", window: "7d", trend: "—", importance: 5 },
        ]);

        const micronutrientRows = (microsRows || []).slice(0, 3).map((row) => ({
          label: row.nutrient_name || "Nutrient",
          current: row.hit_rate_28d != null ? `${formatNumber(row.hit_rate_28d * 100, 0)}%` : "—",
          target: ">=60%",
          window: "28d",
          trend: row.sustained_low ? "low" : "—",
          importance: 5,
        }));
        renderEvidence(nutritionMicrosEl, micronutrientRows.length ? micronutrientRows : [
          { label: "Micros", current: "—", target: "—", window: "28d", trend: "—", importance: 5 },
        ]);

        const trainingState = `Total ${trainingWeek?.workout_count || 0} sessions, ${formatMinutes(trainingWeek?.total_duration_s)} total, ${formatDistance(trainingWeek?.total_distance_m)} distance.`;
        trainingStateEl.textContent = trainingState;
        const trainingActions = [];
        if (plan?.summary_text) {
          trainingActions.push({ title: "Plan", body: plan.summary_text });
        }
        renderActions(trainingActionsEl, trainingActions);

        const trainingConf = [];
        if (coverageWeek?.workout_confidence != null) {
          trainingConf.push({ label: `Confidence ${formatNumber(coverageWeek.workout_confidence * 100, 0)}%`, warn: coverageWeek.workout_confidence < 0.6 });
        }
        if (coverageWeek?.workout_coverage != null) {
          trainingConf.push({ label: `Coverage ${formatNumber(coverageWeek.workout_coverage * 100, 0)}%`, warn: coverageWeek.workout_coverage < 0.7 });
        }
        renderConfidence(trainingConfidenceEl, trainingConf);

        renderEvidence(trainingEvidenceEl, [
          { label: "Workouts", current: trainingWeek?.workout_count ?? "—", target: coverageWeek?.planned_sessions ?? "—", window: "7d", trend: trainingPrev ? trendDelta(trainingWeek?.workout_count, trainingPrev?.workout_count, 0) : "—", importance: 9 },
          { label: "Endurance sessions", current: trainingWeek?.endurance_sessions ?? "—", target: "—", window: "7d", trend: endurancePrev ? trendDelta(enduranceWeek?.session_count, endurancePrev?.session_count, 0) : "—", importance: 8 },
          { label: "Strength sessions", current: trainingWeek?.strength_sessions ?? "—", target: strengthWeek?.planned_sessions ?? "—", window: "7d", trend: strengthPrev ? trendDelta(strengthWeek?.completed_sessions, strengthPrev?.completed_sessions, 0) : "—", importance: 7 },
          { label: "Training load", current: trainingWeek?.training_load_minutes != null ? `${formatNumber(trainingWeek.training_load_minutes, 0)} min` : "—", target: "—", window: "7d", trend: trainingPrev ? trendDelta(trainingWeek?.training_load_minutes, trainingPrev?.training_load_minutes, 0) : "—", importance: 7 },
          { label: "Exercise energy", current: trainingWeek?.exercise_energy_kcal != null ? `${formatNumber(trainingWeek.exercise_energy_kcal, 0)} kcal` : "—", target: "—", window: "7d", trend: "—", importance: 6 },
        ]);

        const sleepStaleDays = dailySleep?.sleep_end ? daysBetween(new Date(dailySleep.sleep_end), new Date()) : null;
        sleepStateEl.textContent = `Last sleep ${formatHours(dailySleep?.duration_s)}. Sleep stale ${sleepStaleDays != null ? formatNumber(sleepStaleDays, 1) : "—"} days.`;
        renderActions(sleepActionsEl, [{ title: "Sleep target", body: "Aim for >=7.0 h tonight. Protect bedtime window." }]);
        renderConfidence(sleepConfidenceEl, [
          { label: sleepStaleDays != null ? `Stale ${formatNumber(sleepStaleDays, 1)}d` : "Stale —", warn: sleepStaleDays != null && sleepStaleDays > 1 },
        ]);
        renderEvidence(sleepEvidenceEl, [
          { label: "Sleep duration", current: formatHours(dailySleep?.duration_s), target: ">=7.0 h", window: "last sleep", trend: "—", importance: 9 },
          { label: "Sleep window", current: dailySleep?.sleep_start ? formatDate(dailySleep.sleep_start) : "—", target: "—", window: "start", trend: "—", importance: 5 },
          { label: "Sleep end", current: dailySleep?.sleep_end ? formatDate(dailySleep.sleep_end) : "—", target: "—", window: "end", trend: "—", importance: 5 },
        ]);

        const strengthState = `Completed ${strengthWeek?.completed_sessions ?? 0}/${strengthWeek?.planned_sessions ?? "—"} sessions. Tonnage ${formatNumber(strengthWeek?.tonnage, 0)}.`;
        strengthStateEl.textContent = strengthState;
        renderActions(strengthActionsEl, [{ title: "Strength", body: "Execute planned sessions; keep PT blocks consistent." }]);
        renderConfidence(strengthConfidenceEl, [
          { label: `Planned ${strengthWeek?.planned_sessions ?? "—"}`, warn: strengthWeek?.completed_sessions < strengthWeek?.planned_sessions },
        ]);
        renderEvidence(strengthEvidenceEl, [
          { label: "Planned sessions", current: strengthWeek?.planned_sessions ?? "—", target: "—", window: "7d", trend: "—", importance: 7 },
          { label: "Completed sessions", current: strengthWeek?.completed_sessions ?? "—", target: strengthWeek?.planned_sessions ?? "—", window: "7d", trend: strengthPrev ? trendDelta(strengthWeek?.completed_sessions, strengthPrev?.completed_sessions, 0) : "—", importance: 8 },
          { label: "Total sets", current: strengthWeek?.total_sets ?? "—", target: "—", window: "7d", trend: strengthPrev ? trendDelta(strengthWeek?.total_sets, strengthPrev?.total_sets, 0) : "—", importance: 6 },
          { label: "Total reps", current: strengthWeek?.total_reps ?? "—", target: "—", window: "7d", trend: strengthPrev ? trendDelta(strengthWeek?.total_reps, strengthPrev?.total_reps, 0) : "—", importance: 6 },
          { label: "Tonnage", current: strengthWeek?.tonnage != null ? formatNumber(strengthWeek.tonnage, 0) : "—", target: "—", window: "7d", trend: strengthPrev ? trendDelta(strengthWeek?.tonnage, strengthPrev?.tonnage, 0) : "—", importance: 6 },
        ]);

        const bodyState = `Weight ${formatNumber(dailyBody?.weight_kg, 1)} kg, BF ${formatNumber(dailyBody?.body_fat_pct, 1)}%, FFM ${formatNumber(dailyBody?.ffm_kg, 1)} kg.`;
        bodyStateEl.textContent = bodyState;
        renderActions(bodyActionsEl, [{ title: "Weigh-in", body: dailyBody?.is_stale ? "Weigh in to refresh body metrics." : "Next weigh-in per schedule." }]);
        renderConfidence(bodyConfidenceEl, [
          { label: dailyBody?.stale_days != null ? `Stale ${formatNumber(dailyBody.stale_days, 1)}d` : "Stale —", warn: dailyBody?.stale_days > 7 },
        ]);
        renderEvidence(bodyEvidenceEl, [
          { label: "Weight", current: formatNumber(dailyBody?.weight_kg, 1), target: "—", window: "latest", trend: dailyBody?.slope_7d_kg_per_week != null ? `${formatNumber(dailyBody.slope_7d_kg_per_week, 2)} kg/wk` : "—", importance: 7 },
          { label: "Body fat", current: formatNumber(dailyBody?.body_fat_pct, 1), target: "—", window: "latest", trend: dailyBody?.slope_28d_pct_per_week != null ? `${formatNumber(dailyBody.slope_28d_pct_per_week, 2)} %/wk` : "—", importance: 6 },
          { label: "FFM", current: formatNumber(dailyBody?.ffm_kg, 1), target: "—", window: "latest", trend: "—", importance: 6 },
          { label: "Volatility", current: formatNumber(dailyBody?.volatility_kg, 2), target: "—", window: "28d", trend: dailyBody?.trend_noise ? "noise" : "—", importance: 5 },
        ]);
      }

      async function init() {
        const { data } = await supabase.auth.getSession();
        if (data?.session) {
          authEl.classList.add("hidden");
          contentEl.classList.remove("hidden");
          await loadReport();
        }
      }

      document.getElementById("login").addEventListener("click", async () => {
        authStatusEl.textContent = "";
        const email = emailEl.value.trim();
        const password = passwordEl.value.trim();
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          authStatusEl.textContent = error.message;
          return;
        }
        authEl.classList.add("hidden");
        contentEl.classList.remove("hidden");
        await loadReport();
      });

      document.getElementById("logout").addEventListener("click", async () => {
        await supabase.auth.signOut();
        contentEl.classList.add("hidden");
        authEl.classList.remove("hidden");
      });

      init();
    </script>
  </body>
</html>

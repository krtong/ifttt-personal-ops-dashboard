<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Personal Ops Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: dark;
        --bg: #0b1020;
        --panel: rgba(15, 23, 42, 0.92);
        --panel-strong: rgba(17, 25, 44, 0.98);
        --card: rgba(12, 18, 34, 0.75);
        --text: #f8fafc;
        --muted: #94a3b8;
        --accent: #38bdf8;
        --accent-strong: #0ea5e9;
        --warn: #f97316;
        --danger: #f43f5e;
        --success: #22c55e;
        --border: rgba(59, 78, 119, 0.5);
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Space Grotesk", system-ui, sans-serif;
        background: radial-gradient(circle at top, #111827 0%, #0b1020 50%, #070b16 100%);
        color: var(--text);
        min-height: 100vh;
      }
      header {
        padding: 28px clamp(20px, 6vw, 60px) 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .title {
        font-size: clamp(28px, 5vw, 44px);
        font-weight: 700;
        letter-spacing: -0.02em;
      }
      .subtitle {
        color: var(--muted);
        font-size: 14px;
      }
      .tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        padding: 0 clamp(20px, 6vw, 60px) 20px;
      }
      .tab {
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.6);
        color: var(--muted);
        padding: 8px 16px;
        border-radius: 999px;
        font-size: 13px;
        cursor: pointer;
        transition: 0.2s ease;
      }
      .tab.active {
        border-color: rgba(56, 189, 248, 0.7);
        color: var(--text);
        background: rgba(14, 165, 233, 0.2);
      }
      main {
        padding: 0 clamp(20px, 6vw, 60px) 60px;
        display: grid;
        gap: 24px;
      }
      .panel {
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
        display: grid;
        gap: 16px;
      }
      .panel.hidden {
        display: none;
      }
      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 12px;
      }
      .panel-title {
        font-size: 18px;
        font-weight: 600;
      }
      .panel-meta {
        color: var(--muted);
        font-size: 12px;
      }
      .grid {
        display: grid;
        gap: 16px;
      }
      .grid.cols-2 {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
      .grid.cols-3 {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      .card {
        background: var(--card);
        border: 1px solid rgba(59, 78, 119, 0.4);
        border-radius: 16px;
        padding: 16px;
        display: grid;
        gap: 8px;
      }
      .card-title {
        font-size: 13px;
        color: var(--muted);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }
      .card-value {
        font-size: 24px;
        font-weight: 600;
      }
      .pill {
        display: inline-flex;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border: 1px solid rgba(56, 189, 248, 0.4);
        color: var(--accent);
      }
      .pill.warn {
        border-color: rgba(249, 115, 22, 0.6);
        color: #fca5a5;
      }
      .pill.good {
        border-color: rgba(34, 197, 94, 0.5);
        color: #86efac;
      }
      .list {
        display: grid;
        gap: 10px;
      }
      .list-item {
        border-radius: 12px;
        border: 1px solid rgba(42, 51, 82, 0.6);
        padding: 12px;
        background: rgba(9, 13, 26, 0.6);
        display: grid;
        gap: 6px;
      }
      .list-title {
        font-weight: 600;
      }
      .list-meta {
        color: var(--muted);
        font-size: 12px;
      }
      .metric-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        font-size: 13px;
        color: var(--muted);
      }
      .metric-row strong {
        color: var(--text);
        font-weight: 600;
      }
      .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid rgba(56, 189, 248, 0.35);
        color: var(--accent);
        background: rgba(14, 165, 233, 0.1);
      }
      .status-chip.good {
        border-color: rgba(34, 197, 94, 0.45);
        color: #86efac;
        background: rgba(34, 197, 94, 0.12);
      }
      .status-chip.warn {
        border-color: rgba(249, 115, 22, 0.55);
        color: #fdba74;
        background: rgba(249, 115, 22, 0.15);
      }
      .status-chip.bad {
        border-color: rgba(244, 63, 94, 0.55);
        color: #fda4af;
        background: rgba(244, 63, 94, 0.15);
      }
      .bar {
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: rgba(30, 41, 59, 0.8);
        overflow: hidden;
        margin-top: 6px;
      }
      .bar-fill {
        height: 100%;
        border-radius: inherit;
        background: var(--accent);
      }
      .bar-fill.good {
        background: var(--success);
      }
      .bar-fill.warn {
        background: var(--warn);
      }
      .bar-fill.bad {
        background: var(--danger);
      }
      .auth {
        max-width: 420px;
        margin: 30px auto;
        display: grid;
        gap: 12px;
        padding: 24px;
        background: var(--panel-strong);
        border-radius: 20px;
        border: 1px solid var(--border);
      }
      .auth input {
        background: rgba(12, 18, 34, 0.9);
        border: 1px solid rgba(59, 78, 119, 0.6);
        border-radius: 10px;
        padding: 10px 12px;
        color: var(--text);
      }
      .btn {
        padding: 10px 16px;
        border-radius: 10px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        background: var(--accent-strong);
        color: #041018;
      }
      .btn.secondary {
        background: rgba(30, 41, 59, 0.8);
        color: var(--text);
        border: 1px solid rgba(59, 78, 119, 0.6);
      }
      .muted {
        color: var(--muted);
        font-size: 12px;
      }
      .highlight {
        color: var(--accent);
      }
      .section-divider {
        border-top: 1px solid rgba(51, 65, 85, 0.5);
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <div class="title">Personal Ops</div>
      <div class="subtitle">Triathlon readiness, posture repair, and strength balance.</div>
    </header>

    <div class="tabs" id="view-tabs"></div>

    <div id="auth" class="auth">
      <div class="panel-title">Sign in</div>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button id="login" class="btn">Sign in</button>
      <div id="auth-status" class="muted"></div>
    </div>

    <main id="content" class="hidden">
      <section id="overview-view" class="panel">
        <div class="panel-header">
          <div class="panel-title">Overview</div>
          <div class="panel-meta" id="overview-updated">—</div>
        </div>
        <div class="grid cols-2" id="overview-metrics"></div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Readiness</div>
            <div id="overview-readiness" class="card-value">—</div>
            <div id="overview-readiness-note" class="muted">—</div>
          </div>
          <div class="card">
            <div class="card-title">Next session</div>
            <div id="overview-next" class="card-value">—</div>
            <div id="overview-next-note" class="muted">—</div>
          </div>
        </div>
        <div class="grid cols-3">
          <div class="card">
            <div class="card-title">Form snapshot</div>
            <div id="overview-forms" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Run readiness</div>
            <div id="overview-run" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Discipline balance</div>
            <div id="overview-balance" class="list"></div>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Today’s actions</div>
            <div id="overview-actions" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Risks & blockers</div>
            <div id="overview-risks" class="list"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Plan summary</div>
          <div id="overview-plan" class="list"></div>
        </div>
        <div id="overview-status" class="muted"></div>
      </section>

      <section id="training-view" class="panel hidden">
        <div class="panel-header">
          <div class="panel-title">Training plan</div>
          <div class="panel-meta" id="training-range">—</div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Weekly focus</div>
            <div id="training-template" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Recent sessions</div>
            <div id="training-recent" class="list"></div>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Run priority</div>
            <div id="training-run" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Run development</div>
            <div class="list">
              <div class="list-item">
                <div class="list-title">Form + durability</div>
                <div class="list-meta">Short easy runs, drills, and tibialis work are priority.</div>
              </div>
              <div class="list-item">
                <div class="list-title">Stride economy</div>
                <div class="list-meta">Add 4–6 strides after easy runs (fast, relaxed).</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Bike & swim strengths</div>
            <div class="list">
              <div class="list-item">
                <div class="list-title">Swim consistency</div>
                <div class="list-meta">Maintain 1,000 yd/day base with technique focus.</div>
              </div>
              <div class="list-item">
                <div class="list-title">Bike endurance</div>
                <div class="list-meta">Long aerobic ride + posture reset after riding.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Form snapshot</div>
            <div id="training-forms" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Plan blocks</div>
            <div id="training-blocks" class="list"></div>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Action pack (today)</div>
            <div id="training-actions" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Weakest link</div>
            <div id="training-weakest" class="list"></div>
          </div>
        </div>
      </section>

      <section id="strength-view" class="panel hidden">
        <div class="panel-header">
          <div class="panel-title">Strength & posture</div>
          <div class="panel-meta" id="strength-note">—</div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Strength baselines</div>
            <div id="strength-baselines" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Last session breakdown</div>
            <div id="strength-last" class="list"></div>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Posture reset (daily 10–15m)</div>
            <div class="list">
              <div class="list-item">
                <div class="list-title">Forward head + rounded shoulders</div>
                <div class="list-meta">Chin tucks · Scap retraction · Thoracic extension · Pec stretch</div>
              </div>
              <div class="list-item">
                <div class="list-title">Anterior pelvic tilt</div>
                <div class="list-meta">Glute bridges · Dead bug · Hip flexor stretch · Hamstring hinge</div>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="card-title">Run durability (tibias + feet)</div>
            <div class="list">
              <div class="list-item">
                <div class="list-title">Tibialis raises</div>
                <div class="list-meta">2–3 sets, controlled tempo.</div>
              </div>
              <div class="list-item">
                <div class="list-title">Calf + foot intrinsics</div>
                <div class="list-meta">Standing calf raises + short-foot drills.</div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Face & neck routine (5–8m)</div>
          <div class="list">
            <div class="list-item">
              <div class="list-title">Neck isometrics</div>
              <div class="list-meta">Front/side/back holds · 10–15s each.</div>
            </div>
            <div class="list-item">
              <div class="list-title">Jawline & neckline</div>
              <div class="list-meta">Light resistance + posture awareness, avoid jaw tension.</div>
            </div>
          </div>
        </div>
      </section>

      <section id="nutrition-view" class="panel hidden">
        <div class="panel-header">
          <div class="panel-title">Nutrition</div>
          <div class="panel-meta" id="nutrition-note">—</div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Targets vs actual</div>
            <div id="nutrition-targets" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Guidance</div>
            <div class="list">
              <div class="list-item">
                <div class="list-title">Protein anchor</div>
                <div class="list-meta">Hit target daily to support recovery + posture work.</div>
              </div>
              <div class="list-item">
                <div class="list-title">Carb timing</div>
                <div class="list-meta">Prioritize carbs before/after run sessions.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section id="recovery-view" class="panel hidden">
        <div class="panel-header">
          <div class="panel-title">Recovery</div>
          <div class="panel-meta" id="recovery-note">—</div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Sleep</div>
            <div id="recovery-sleep" class="card-value">—</div>
            <div id="recovery-sleep-note" class="muted">—</div>
          </div>
          <div class="card">
            <div class="card-title">Weight</div>
            <div id="recovery-weight" class="card-value">—</div>
            <div id="recovery-weight-note" class="muted">—</div>
          </div>
        </div>
        <div class="grid cols-2">
          <div class="card">
            <div class="card-title">Readiness + form</div>
            <div id="recovery-readiness" class="list"></div>
          </div>
          <div class="card">
            <div class="card-title">Recovery targets</div>
            <div id="recovery-targets" class="list"></div>
          </div>
        </div>
      </section>

      <button id="logout" class="btn secondary">Sign out</button>
    </main>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

      const SUPABASE_URL = "https://tbrnarytcojngpbzzwcn.supabase.co";
      const SUPABASE_ANON_KEY = "sb_publishable_E8-dvNNh5V3VQLAcK-xqiQ_dLEu1Bsh";
      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const viewTabsEl = document.getElementById("view-tabs");
      const authEl = document.getElementById("auth");
      const authStatusEl = document.getElementById("auth-status");
      const contentEl = document.getElementById("content");
      const emailEl = document.getElementById("email");
      const passwordEl = document.getElementById("password");

      const VIEW_DEFS = {
        overview: { label: "Overview" },
        training: { label: "Training" },
        strength: { label: "Strength/PT" },
        nutrition: { label: "Nutrition" },
        recovery: { label: "Recovery" },
      };
      let currentView = "overview";

      const overviewMetricsEl = document.getElementById("overview-metrics");
      const overviewUpdatedEl = document.getElementById("overview-updated");
      const overviewReadinessEl = document.getElementById("overview-readiness");
      const overviewReadinessNoteEl = document.getElementById("overview-readiness-note");
      const overviewNextEl = document.getElementById("overview-next");
      const overviewNextNoteEl = document.getElementById("overview-next-note");
      const overviewPlanEl = document.getElementById("overview-plan");
      const overviewActionsEl = document.getElementById("overview-actions");
      const overviewRisksEl = document.getElementById("overview-risks");
      const overviewStatusEl = document.getElementById("overview-status");
      const overviewFormsEl = document.getElementById("overview-forms");
      const overviewRunEl = document.getElementById("overview-run");
      const overviewBalanceEl = document.getElementById("overview-balance");

      const trainingTemplateEl = document.getElementById("training-template");
      const trainingRecentEl = document.getElementById("training-recent");
      const trainingRangeEl = document.getElementById("training-range");
      const trainingRunEl = document.getElementById("training-run");
      const trainingActionsEl = document.getElementById("training-actions");
      const trainingWeakestEl = document.getElementById("training-weakest");
      const trainingFormsEl = document.getElementById("training-forms");
      const trainingBlocksEl = document.getElementById("training-blocks");

      const strengthNoteEl = document.getElementById("strength-note");
      const strengthBaselinesEl = document.getElementById("strength-baselines");
      const strengthLastEl = document.getElementById("strength-last");

      const nutritionNoteEl = document.getElementById("nutrition-note");
      const nutritionTargetsEl = document.getElementById("nutrition-targets");

      const recoveryNoteEl = document.getElementById("recovery-note");
      const recoverySleepEl = document.getElementById("recovery-sleep");
      const recoverySleepNoteEl = document.getElementById("recovery-sleep-note");
      const recoveryWeightEl = document.getElementById("recovery-weight");
      const recoveryWeightNoteEl = document.getElementById("recovery-weight-note");
      const recoveryReadinessEl = document.getElementById("recovery-readiness");
      const recoveryTargetsEl = document.getElementById("recovery-targets");

      const WEEK_TEMPLATE = [
        { day: "Sunday", focus: "Rest + mobility", note: "Light movement, posture reset." },
        { day: "Monday", focus: "Swim technique", note: "1,000–1,600 yd + posture." },
        { day: "Tuesday", focus: "Strength + tibias", note: "Speediance strength + tibialis work." },
        { day: "Wednesday", focus: "Easy run + drills", note: "Short run + strides, KB optional." },
        { day: "Thursday", focus: "Bike endurance", note: "Long ride + posture reset." },
        { day: "Friday", focus: "Strength + short run", note: "Single-leg + trunk + easy run." },
        { day: "Saturday", focus: "Long run / brick", note: "Long run or bike→run brick." },
      ];

      function renderTabs() {
        viewTabsEl.innerHTML = "";
        Object.entries(VIEW_DEFS).forEach(([id, view]) => {
          const btn = document.createElement("button");
          btn.className = "tab" + (currentView === id ? " active" : "");
          btn.textContent = view.label;
          btn.addEventListener("click", () => {
            currentView = id;
            setActiveView();
            loadView();
          });
          viewTabsEl.appendChild(btn);
        });
      }

      function setActiveView() {
        document.querySelectorAll("main > section").forEach((section) => {
          section.classList.toggle("hidden", !section.id.startsWith(currentView));
        });
        renderTabs();
      }

      function formatNumber(value, decimals = 0) {
        if (value === null || value === undefined || Number.isNaN(value)) return "—";
        return Number(value).toFixed(decimals);
      }

      function formatMinutes(seconds) {
        if (!seconds) return "—";
        return `${Math.round(seconds / 60)} min`;
      }

      function formatDistance(meters) {
        if (!meters) return "—";
        return `${(meters / 1609.34).toFixed(1)} mi`;
      }

      function formatTimestamp(value) {
        if (!value) return "—";
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return "—";
        return date.toLocaleString();
      }

      function formatSleep(seconds) {
        if (!seconds) return "—";
        return `${(seconds / 3600).toFixed(1)} h`;
      }

      function renderListItem(title, meta) {
        const item = document.createElement("div");
        item.className = "list-item";
        item.innerHTML = `<div class="list-title">${title}</div><div class="list-meta">${meta}</div>`;
        return item;
      }

      function pushAction(listEl, title, meta) {
        if (!listEl) return;
        listEl.appendChild(renderListItem(title, meta));
      }

      function renderMetricRow(label, value) {
        const row = document.createElement("div");
        row.className = "metric-row";
        row.innerHTML = `<span>${label}</span><strong>${value}</strong>`;
        return row;
      }

      function renderStatusItem(title, status, tone = "good", meta = "") {
        const item = document.createElement("div");
        item.className = "list-item";
        const metaHtml = meta ? `<div class="list-meta">${meta}</div>` : "";
        item.innerHTML = `<div class="list-title">${title}</div>${metaHtml}`;
        const chip = document.createElement("div");
        chip.className = `status-chip ${tone}`;
        chip.textContent = status;
        item.appendChild(chip);
        return item;
      }

      function renderBarItem(title, status, tone = "good", percent = 60, meta = "") {
        const item = document.createElement("div");
        item.className = "list-item";
        const metaHtml = meta ? `<div class="list-meta">${meta}</div>` : "";
        item.innerHTML = `<div class="list-title">${title}</div>${metaHtml}`;
        const chip = document.createElement("div");
        chip.className = `status-chip ${tone}`;
        chip.textContent = status;
        item.appendChild(chip);
        const bar = document.createElement("div");
        bar.className = "bar";
        const fill = document.createElement("div");
        fill.className = `bar-fill ${tone}`;
        fill.style.width = `${Math.max(5, Math.min(percent, 100))}%`;
        bar.appendChild(fill);
        item.appendChild(bar);
        return item;
      }

      function bandFromScore(score) {
        if (score == null || Number.isNaN(score)) {
          return { label: "Unknown", tone: "warn" };
        }
        if (score >= 70) return { label: "Green", tone: "good" };
        if (score >= 50) return { label: "Yellow", tone: "warn" };
        return { label: "Red", tone: "bad" };
      }

      function formBand(value) {
        if (value == null || Number.isNaN(value)) return { label: "Unknown", tone: "warn" };
        if (value >= 8) return { label: "Fresh", tone: "good" };
        if (value >= -4) return { label: "Steady", tone: "warn" };
        return { label: "Loaded", tone: "bad" };
      }

      function frequencyBand(count) {
        if (count >= 2) return { label: "On track", tone: "good", percent: 90 };
        if (count === 1) return { label: "Light", tone: "warn", percent: 55 };
        return { label: "Missing", tone: "bad", percent: 15 };
      }

      function durationBand(minutes) {
        if (!minutes) return "Flexible";
        if (minutes <= 20) return "Short";
        if (minutes <= 40) return "Medium";
        if (minutes <= 60) return "Long";
        return "Extended";
      }

      async function fetchStravaStats(days = 7) {
        const since = new Date();
        since.setDate(since.getDate() - days);
        const resp = await supabase
          .from("pos_events")
          .select("event_timestamp,payload")
          .eq("source", "strava")
          .eq("event_type", "activity")
          .gte("event_timestamp", since.toISOString());
        const stats = {
          runCount: 0,
          swimCount: 0,
          rideCount: 0,
          lastRun: null,
          lastSwim: null,
          lastRide: null,
        };
        if (!resp.data) return stats;
        resp.data.forEach((row) => {
          const payload = row.payload || {};
          const type = String(payload.type ?? payload.sport_type ?? "").toLowerCase();
          if (type.includes("run")) {
            stats.runCount += 1;
            if (!stats.lastRun) stats.lastRun = row.event_timestamp;
          } else if (type.includes("swim")) {
            stats.swimCount += 1;
            if (!stats.lastSwim) stats.lastSwim = row.event_timestamp;
          } else if (type.includes("ride") || type.includes("bike") || type.includes("cycle")) {
            stats.rideCount += 1;
            if (!stats.lastRide) stats.lastRide = row.event_timestamp;
          }
        });
        return stats;
      }

      async function loadOverview() {
        overviewMetricsEl.innerHTML = "";
        overviewPlanEl.innerHTML = "";
        overviewStatusEl.textContent = "";
        overviewActionsEl.innerHTML = "";
        overviewRisksEl.innerHTML = "";
        overviewFormsEl.innerHTML = "";
        overviewRunEl.innerHTML = "";
        overviewBalanceEl.innerHTML = "";

        const [trainingResp, readinessResp, metricsResp, planResp, stravaStats] = await Promise.all([
          supabase.from("training_state").select("*").eq("id", "global").maybeSingle(),
          supabase.from("readiness_state").select("*").eq("id", "global").maybeSingle(),
          supabase.from("pos_day_metrics").select("*").order("date", { ascending: false }).limit(1),
          supabase.from("coach_plan_daily").select("date,summary_text,plan_json").order("date", { ascending: false }).limit(1),
          fetchStravaStats(7),
        ]);

        const training = trainingResp.data || {};
        const readiness = readinessResp.data || {};
        const metrics = metricsResp.data?.[0] || {};
        const plan = planResp.data?.[0];

        const metricsList = [
          { label: "Run frequency", value: frequencyBand(stravaStats.runCount) },
          { label: "Swim frequency", value: frequencyBand(stravaStats.swimCount) },
          { label: "Bike frequency", value: frequencyBand(stravaStats.rideCount) },
          { label: "Strength frequency", value: frequencyBand(metrics.strength_sessions_7d ?? training.strength_sessions_7d ?? 0) },
        ];

        metricsList.forEach((metric) => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `<div class="card-title">${metric.label}</div><div class="card-value">${metric.value.label}</div>`;
          const bar = document.createElement("div");
          bar.className = "bar";
          const fill = document.createElement("div");
          fill.className = `bar-fill ${metric.value.tone}`;
          fill.style.width = `${metric.value.percent}%`;
          bar.appendChild(fill);
          card.appendChild(bar);
          overviewMetricsEl.appendChild(card);
        });

        overviewUpdatedEl.textContent = metrics.updated_at ? `Updated ${formatTimestamp(metrics.updated_at)}` : "—";
        const readinessScore = readiness.readiness_score ?? metrics.readiness_score;
        const readinessBand = bandFromScore(readinessScore);
        overviewReadinessEl.textContent = readinessBand.label;
        const sleepNote = metrics.sleep_updated_at ? `Sleep updated ${formatTimestamp(metrics.sleep_updated_at)}` : "Sleep missing";
        const weightNote = metrics.weight_updated_at ? `Weight updated ${formatTimestamp(metrics.weight_updated_at)}` : "Weight missing";
        overviewReadinessNoteEl.textContent = `${sleepNote} · ${weightNote}`;

        overviewNextEl.textContent = metrics.next_workout_start ? new Date(metrics.next_workout_start).toLocaleDateString() : "—";
        overviewNextNoteEl.textContent = metrics.next_workout_start ? formatTimestamp(metrics.next_workout_start) : "No upcoming workout";

        const planJson = plan?.plan_json || {};
        const stravaForms = planJson.strava_forms || {};
        const formRun = formBand(stravaForms.running ?? metrics.strava_form_running);
        const formBike = formBand(stravaForms.cycling ?? metrics.strava_form_cycling);
        const formSwim = formBand(stravaForms.swimming ?? metrics.strava_form_swimming);
        overviewFormsEl.appendChild(renderStatusItem("Run form", formRun.label, formRun.tone, "Strava freshness"));
        overviewFormsEl.appendChild(renderStatusItem("Bike form", formBike.label, formBike.tone, "Strava freshness"));
        overviewFormsEl.appendChild(renderStatusItem("Swim form", formSwim.label, formSwim.tone, "Strava freshness"));

        const runLevel = planJson.run_level || "walk";
        overviewRunEl.appendChild(renderStatusItem("Current level", runLevel === "walk" ? "Walk-only" : "Run/walk", runLevel === "walk" ? "warn" : "good"));
        overviewRunEl.appendChild(renderListItem("Next upgrade", "Hold walk baseline. Add short jog intervals once cleared."));

        const swimFreq = frequencyBand(stravaStats.swimCount);
        const bikeFreq = frequencyBand(stravaStats.rideCount);
        const runFreq = frequencyBand(stravaStats.runCount);
        overviewBalanceEl.appendChild(renderBarItem("Swim", swimFreq.label, swimFreq.tone, swimFreq.percent));
        overviewBalanceEl.appendChild(renderBarItem("Bike", bikeFreq.label, bikeFreq.tone, bikeFreq.percent));
        overviewBalanceEl.appendChild(renderBarItem("Run", runFreq.label, runFreq.tone, runFreq.percent));

        if (plan) {
          overviewPlanEl.appendChild(renderListItem("Summary", plan.summary_text || "—"));
          const rec = planJson.recommendation;
          if (rec) {
            overviewPlanEl.appendChild(renderListItem("Focus", `${rec.type ?? "—"} · ${durationBand(rec.duration_min)} · ${rec.intensity ?? "—"}`));
          }
        } else {
          overviewPlanEl.appendChild(renderListItem("Summary", "No plan yet."));
        }

        overviewStatusEl.textContent = readiness.readiness_score ? "Ready to progress with caution." : "Waiting on readiness data.";

        const rec = planJson.recommendation || {};
        const nutritionCodes = planJson.nutrition_targets?.reason_codes || [];

        // Action recipe
        if (rec?.type) {
          pushAction(
            overviewActionsEl,
            "Primary session",
            `${rec.type} · ${rec.duration_min ?? "—"} min · ${rec.intensity ?? "—"}`,
          );
        } else {
          pushAction(overviewActionsEl, "Primary session", "Follow weekly plan focus and keep intensity easy.");
        }

        if (readinessBand.label === "Red") {
          pushAction(overviewActionsEl, "Intensity cap", "Stay in easy zones; skip hard intervals.");
        } else if (readinessBand.label === "Green") {
          pushAction(overviewActionsEl, "Quality window", "Green light for a focused session if time allows.");
        }

        if (stravaStats.runCount < 2) {
          pushAction(overviewActionsEl, "Run durability", "Add a short easy run or walk + 4 strides.");
        }

        pushAction(overviewActionsEl, "Posture reset", "10–15 min: chin tucks, scap retraction, hip flexor stretch.");

        if (nutritionCodes.includes("LOW_PROTEIN")) {
          pushAction(overviewActionsEl, "Protein", "Add 30–40g protein (shake, chicken, Greek yogurt)." );
        }
        if (nutritionCodes.includes("LOW_CALORIES")) {
          pushAction(overviewActionsEl, "Fuel", "Calories low — add carbs pre/post run.");
        }

        // Risks & blockers
        if (stravaStats.runCount === 0) {
          pushAction(overviewRisksEl, "Run gap", "No run in 7d — prioritize short easy run today.");
        }
        if (readinessBand.label === "Red") {
          pushAction(overviewRisksEl, "Low readiness", "Reduce volume and avoid intensity.");
        }
        if (metrics.sleep_seconds && metrics.sleep_seconds < 5 * 3600) {
          pushAction(overviewRisksEl, "Sleep debt", "Sleep <5h. Protect tonight's bedtime.");
        }
        if (!overviewRisksEl.children.length) {
          pushAction(overviewRisksEl, "All clear", "No major blockers today.");
        }
      }

      async function loadTraining() {
        trainingTemplateEl.innerHTML = "";
        trainingRecentEl.innerHTML = "";
        trainingRunEl.innerHTML = "";
        trainingActionsEl.innerHTML = "";
        trainingWeakestEl.innerHTML = "";
        trainingFormsEl.innerHTML = "";
        trainingBlocksEl.innerHTML = "";

        const [calendarResp, stravaResp, strengthResp, planResp, metricsResp] = await Promise.all([
          supabase.from("calendar_state").select("next_workout_start,next_workout_end,meeting_load_24h").eq("id", "global").maybeSingle(),
          supabase.from("pos_events").select("event_timestamp,payload").eq("source", "strava").eq("event_type", "activity").order("event_timestamp", { ascending: false }).limit(50),
          supabase.from("speediance_training_session_scores").select("session_date,quality_score").order("session_date", { ascending: false }).limit(1),
          supabase.from("coach_plan_daily").select("plan_json").order("date", { ascending: false }).limit(1),
          supabase.from("pos_day_metrics").select("strava_form_running,strava_form_cycling,strava_form_swimming").order("date", { ascending: false }).limit(1),
        ]);

        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay());
        trainingRangeEl.textContent = `Week of ${weekStart.toLocaleDateString()}`;

        const planJson = planResp.data?.[0]?.plan_json || {};
        const planBlocks = planJson.plan_blocks || [];
        const template = planBlocks.length
          ? planBlocks.map((block) => ({
              day: block.day,
              focus: block.focus,
              note: block.note,
            }))
          : WEEK_TEMPLATE;

        template.forEach((entry, idx) => {
          const isToday = idx === now.getDay();
          const title = `${entry.day} · ${entry.focus}`;
          const meta = `${entry.note}${isToday ? " · Today" : ""}`;
          trainingTemplateEl.appendChild(renderListItem(title, meta));
        });

        const lastByType = { swim: null, ride: null, run: null };
        const counts = { swim: 0, ride: 0, run: 0 };
        (stravaResp.data || []).forEach((row) => {
          const payload = row.payload || {};
          const type = String(payload.type ?? payload.sport_type ?? "").toLowerCase();
          if (type.includes("swim")) {
            counts.swim += 1;
            if (!lastByType.swim) lastByType.swim = row.event_timestamp;
          } else if (type.includes("ride") || type.includes("bike") || type.includes("cycle")) {
            counts.ride += 1;
            if (!lastByType.ride) lastByType.ride = row.event_timestamp;
          } else if (type.includes("run")) {
            counts.run += 1;
            if (!lastByType.run) lastByType.run = row.event_timestamp;
          }
        });

        trainingRecentEl.appendChild(renderListItem("Swim", lastByType.swim ? formatTimestamp(lastByType.swim) : "No recent swim"));
        trainingRecentEl.appendChild(renderListItem("Bike", lastByType.ride ? formatTimestamp(lastByType.ride) : "No recent ride"));
        trainingRecentEl.appendChild(renderListItem("Run", lastByType.run ? formatTimestamp(lastByType.run) : "No recent run"));
        const strengthRow = strengthResp.data?.[0];
        trainingRecentEl.appendChild(renderListItem("Strength", strengthRow?.session_date ? strengthRow.session_date : "No recent strength"));

        const calendar = calendarResp.data || {};
        if (calendar.next_workout_start) {
          trainingRecentEl.appendChild(renderListItem("Next workout", formatTimestamp(calendar.next_workout_start)));
        }

        const stravaForms = planJson.strava_forms || {};
        const formRun = formBand(stravaForms.running ?? metricsResp.data?.[0]?.strava_form_running);
        const formBike = formBand(stravaForms.cycling ?? metricsResp.data?.[0]?.strava_form_cycling);
        const formSwim = formBand(stravaForms.swimming ?? metricsResp.data?.[0]?.strava_form_swimming);
        trainingFormsEl.appendChild(renderStatusItem("Run form", formRun.label, formRun.tone, "Strava freshness"));
        trainingFormsEl.appendChild(renderStatusItem("Bike form", formBike.label, formBike.tone, "Strava freshness"));
        trainingFormsEl.appendChild(renderStatusItem("Swim form", formSwim.label, formSwim.tone, "Strava freshness"));

        const runLevel = planJson.run_level || "walk";
        trainingBlocksEl.appendChild(renderStatusItem("Run level", runLevel === "walk" ? "Walk-only" : "Run/walk", runLevel === "walk" ? "warn" : "good"));
        if (planBlocks.length) {
          planBlocks.forEach((block) => {
            const meta = [block.endurance, block.strength ? `Strength ${block.strength}` : null, block.pt ? "PT" : null, block.face ? "Face/neck" : null]
              .filter(Boolean)
              .join(" · ");
            trainingBlocksEl.appendChild(renderListItem(block.day, meta || block.note || "—"));
          });
        } else {
          trainingBlocksEl.appendChild(renderListItem("Plan blocks", "No plan blocks found."));
        }

        const runPriority = lastByType.run
          ? "Keep volume easy, add strides if fresh."
          : "No recent run. Add a short easy run or walk + drills.";
        trainingRunEl.appendChild(renderListItem("Run durability", runPriority));
        if (runLevel === "walk") {
          trainingRunEl.appendChild(renderListItem("Baseline", "Walk-only until tolerance improves. No jogging yet."));
        }
        trainingRunEl.appendChild(renderListItem("Tibia resilience", "Tibialis raises + calf work 2–3 sets."));
        trainingRunEl.appendChild(renderListItem("Form cue", "Shorter stride, faster cadence, posture tall."));

        // Action pack: pick 3 highest-impact actions today
        if (counts.run < 2) {
          trainingActionsEl.appendChild(renderListItem("Easy run", "Short easy run or walk + 4 strides."));
        }
        if (counts.swim < 2) {
          trainingActionsEl.appendChild(renderListItem("Swim technique", "Easy technique swim, keep it smooth."));
        }
        if (counts.ride < 2) {
          trainingActionsEl.appendChild(renderListItem("Bike endurance", "Easy aerobic ride, posture reset after."));
        }
        trainingActionsEl.appendChild(renderListItem("Posture reset", "10–15 min: chin tucks, scapular work, hip flexor stretch."));

        const weakest = [
          { name: "Run", count: counts.run },
          { name: "Swim", count: counts.swim },
          { name: "Bike", count: counts.ride },
        ].sort((a, b) => a.count - b.count);
        const weakestLink = weakest[0];
        trainingWeakestEl.appendChild(renderListItem("Lowest frequency", `${weakestLink.name} (${weakestLink.count} sessions in 7d)`));
        if (weakestLink.name === "Run") {
          trainingWeakestEl.appendChild(renderListItem("Fix", "Add two short runs this week + tibia work."));
        } else if (weakestLink.name === "Swim") {
          trainingWeakestEl.appendChild(renderListItem("Fix", "Add 1–2 technique swims to keep feel for water."));
        } else {
          trainingWeakestEl.appendChild(renderListItem("Fix", "Add 1–2 aerobic rides, keep posture tall."));
        }
      }

      async function loadStrength() {
        strengthBaselinesEl.innerHTML = "";
        strengthLastEl.innerHTML = "";
        strengthNoteEl.textContent = "";

        const [baselineResp, sessionResp, metricsResp] = await Promise.all([
          supabase.from("speediance_exercise_baselines").select("action_library_name,max_watts,one_rm,total_reps,last_seen_at").order("max_watts", { ascending: false }).limit(6),
          supabase.from("speediance_training_session_scores").select("training_id,session_date,quality_score").order("session_date", { ascending: false }).limit(1),
          supabase.from("speediance_exercise_session_metrics").select("action_library_name,quality_score,rep_time_cv,completion_ratio,avg_watts,total_reps").order("session_date", { ascending: false }).limit(6),
        ]);

        if (baselineResp.data?.length) {
          const maxWatts = Math.max(...baselineResp.data.map((row) => row.max_watts || 0));
          baselineResp.data.forEach((row) => {
            const ratio = maxWatts ? (row.max_watts || 0) / maxWatts : 0;
            const tone = ratio > 0.75 ? "good" : ratio > 0.4 ? "warn" : "bad";
            const status = ratio > 0.75 ? "High power" : ratio > 0.4 ? "Moderate" : "Develop";
            const percent = ratio * 100;
            strengthBaselinesEl.appendChild(renderBarItem(row.action_library_name || "Exercise", status, tone, percent));
          });
        } else {
          strengthBaselinesEl.appendChild(renderListItem("No baselines", "Run a strength session to populate."));
        }

        if (sessionResp.data?.length) {
          const session = sessionResp.data[0];
          strengthNoteEl.textContent = session.session_date ? `Last session: ${session.session_date}` : "";
        }

        if (metricsResp.data?.length) {
          metricsResp.data.forEach((row) => {
            const quality = row.quality_score ?? 0;
            const tone = quality > 70 ? "good" : quality > 45 ? "warn" : "bad";
            const status = quality > 70 ? "Strong quality" : quality > 45 ? "Needs polish" : "Technique focus";
            strengthLastEl.appendChild(renderStatusItem(row.action_library_name || "Exercise", status, tone, "Based on last session"));
          });
        } else {
          strengthLastEl.appendChild(renderListItem("No session details", "Run a session to populate."));
        }
      }

      async function loadNutrition() {
        nutritionTargetsEl.innerHTML = "";
        nutritionNoteEl.textContent = "";

        const dateKey = new Date().toISOString().slice(0, 10);
        const [metricsResp, planResp] = await Promise.all([
          supabase.from("pos_day_metrics").select("nutrition_entries_7d,calories_avg_day,protein_avg_day,carbs_avg_day,fat_avg_day").order("date", { ascending: false }).limit(1),
          supabase.from("coach_plan_daily").select("plan_json").lte("date", dateKey).order("date", { ascending: false }).limit(1),
        ]);

        const metrics = metricsResp.data?.[0] || {};
        const targets = planResp.data?.[0]?.plan_json?.nutrition_targets || {};
        nutritionNoteEl.textContent = metrics.nutrition_entries_7d ? `${metrics.nutrition_entries_7d} logs in last 7d` : "No logs yet";

        const rows = [
          { label: "Calories", actual: metrics.calories_avg_day, target: targets.calories_target },
          { label: "Protein", actual: metrics.protein_avg_day, target: targets.protein_target_g },
          { label: "Carbs", actual: metrics.carbs_avg_day, target: targets.carbs_target_g },
          { label: "Fat", actual: metrics.fat_avg_day, target: targets.fat_target_g },
        ];

        rows.forEach((row) => {
          if (!row.actual || !row.target) {
            nutritionTargetsEl.appendChild(renderStatusItem(row.label, "No data", "warn", "Needs logging"));
            return;
          }
          const ratio = row.actual / row.target;
          const tone = ratio >= 0.9 ? "good" : ratio >= 0.6 ? "warn" : "bad";
          const status = ratio >= 0.9 ? "On target" : ratio >= 0.6 ? "Low" : "Very low";
          nutritionTargetsEl.appendChild(renderBarItem(row.label, status, tone, Math.min(100, ratio * 100)));
        });
      }

      async function loadRecovery() {
        recoveryReadinessEl.innerHTML = "";
        recoveryTargetsEl.innerHTML = "";
        recoveryNoteEl.textContent = "";

        const [metricsResp, readinessResp, planResp] = await Promise.all([
          supabase.from("pos_day_metrics").select("sleep_seconds,sleep_baseline_7d,weight_kg,weight_baseline_7d,readiness_score,form_score,fatigue_score,updated_at").order("date", { ascending: false }).limit(1),
          supabase.from("readiness_state").select("sleep_updated_at,weight_updated_at,readiness_score").eq("id", "global").maybeSingle(),
          supabase.from("coach_plan_daily").select("plan_json").order("date", { ascending: false }).limit(1),
        ]);

        const metrics = metricsResp.data?.[0] || {};
        const readiness = readinessResp.data || {};
        const plan = planResp.data?.[0];

        const sleepBand = metrics.sleep_seconds && metrics.sleep_baseline_7d
          ? metrics.sleep_seconds >= metrics.sleep_baseline_7d * 0.9
            ? { label: "On target", tone: "good" }
            : metrics.sleep_seconds >= metrics.sleep_baseline_7d * 0.7
              ? { label: "Low", tone: "warn" }
              : { label: "Very low", tone: "bad" }
          : { label: "Unknown", tone: "warn" };
        recoverySleepEl.textContent = sleepBand.label;
        recoverySleepNoteEl.textContent = metrics.sleep_baseline_7d ? "Compared to baseline" : "Baseline missing";

        const weightBand = metrics.weight_kg && metrics.weight_baseline_7d
          ? { label: "Tracking", tone: "good" }
          : { label: "Missing", tone: "warn" };
        recoveryWeightEl.textContent = weightBand.label;
        recoveryWeightNoteEl.textContent = metrics.weight_baseline_7d ? "Weight trend active" : "Baseline missing";

        const readinessBand = bandFromScore(readiness.readiness_score ?? metrics.readiness_score);
        recoveryReadinessEl.appendChild(renderStatusItem("Readiness", readinessBand.label, readinessBand.tone, "Overall state"));
        const formBandState = formBand(metrics.form_score);
        recoveryReadinessEl.appendChild(renderStatusItem("Form", formBandState.label, formBandState.tone, "Training freshness"));
        recoveryReadinessEl.appendChild(renderStatusItem("Fatigue", metrics.fatigue_score != null && metrics.fatigue_score < 40 ? "Low" : "Elevated", metrics.fatigue_score != null && metrics.fatigue_score < 40 ? "good" : "warn", "7‑day load"));

        const sleepTarget = plan?.plan_json?.recovery_targets?.sleep_target_hours;
        recoveryTargetsEl.appendChild(renderListItem("Sleep target", sleepTarget ? `${sleepTarget} h` : "—"));
        recoveryNoteEl.textContent = metrics.updated_at ? `Updated ${formatTimestamp(metrics.updated_at)}` : "—";
      }

      async function loadView() {
        if (currentView === "overview") await loadOverview();
        if (currentView === "training") await loadTraining();
        if (currentView === "strength") await loadStrength();
        if (currentView === "nutrition") await loadNutrition();
        if (currentView === "recovery") await loadRecovery();
      }

      async function refreshSession() {
        const { data } = await supabase.auth.getSession();
        const session = data?.session;
        if (session) {
          authEl.classList.add("hidden");
          contentEl.classList.remove("hidden");
          renderTabs();
          setActiveView();
          await loadView();
        } else {
          authEl.classList.remove("hidden");
          contentEl.classList.add("hidden");
          if (authStatusEl) authStatusEl.textContent = "Please sign in";
        }
      }

      document.getElementById("login").addEventListener("click", async () => {
        const email = emailEl.value.trim();
        const password = passwordEl.value;
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          if (authStatusEl) authStatusEl.textContent = `Sign in failed: ${error.message}`;
          return;
        }
        await refreshSession();
      });

      document.getElementById("logout").addEventListener("click", async () => {
        await supabase.auth.signOut();
        await refreshSession();
      });

      refreshSession();
    </script>
  </body>
</html>
